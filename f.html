<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Space Repetition</title>
<style>
:root{--bg:#0f1220;--card:#181c2f;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--ok:#7bd88f;--warn:#ffd166;--bad:#ff7575;--accent:#6ca8ff}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
header,footer{padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
h1{margin:0;font-size:18px;letter-spacing:.2px}
.wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:420px 1fr;gap:16px}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 0 0 1px rgba(255,255,255,.05) inset;overflow-x:auto}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.muted{color:var(--muted)}.right{text-align:right}
input,textarea,button,select{background:#12162a;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:8px}
button{cursor:pointer}.primary{background:linear-gradient(180deg,#2f67ff,#2149c8);border:none}
.sep{height:1px;background:var(--line);opacity:.6;margin:10px 0}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{aspect-ratio:1/1;background:#12162a;border:1px solid var(--line);border-radius:10px;padding:8px;display:flex;flex-direction:column;justify-content:space-between}
.dnum{font-size:12px;color:var(--muted)}.count{font-size:18px;text-align:right}
.summary{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-top:8px}
.big{font-size:28px;font-weight:700}.pill{background:#12162a;border:1px solid var(--line);border-radius:999px;padding:10px 12px;display:inline-flex;gap:8px}
.badge{padding:4px 8px;border-radius:20px;border:1px solid var(--line);font-size:12px}
.badge.due{border-color:#ffd166}.badge.late{border-color:#ff7575}.badge.ok{border-color:#7bd88f}
.topicrow{display:grid;grid-template-columns:1fr 100px 100px 1fr;gap:8px;align-items:center;margin-bottom:6px}
.queueitem{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);padding:10px;border-radius:10px}
.qbtns button{min-width:64px}
.small{font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Space Repetition</h1>
  <div class="row">
    <button id="exportJson">Export JSON</button>
    <label class="muted">Import <input id="importJson" type="file" accept="application/json" style="display:none"/></label>
    <button id="exportIcs" title="Export next due reviews to .ics with alerts">Export ICS</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: add & today queue -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div><b>Add Topic</b></div>
      <div class="small muted">SM-2 scheduling â€¢ times shown in your local time</div>
    </div>
    <div class="row">
      <input id="tTitle" placeholder="Topic title" style="flex:1"/>
      <input id="tTags"  placeholder="tags (comma)" />
    </div>
    <div class="row">
      <label class="small muted">Start today?</label>
      <select id="tStart">
        <option value="today">Yes</option>
        <option value="tomorrow">Tomorrow</option>
      </select>
      <label class="small muted">Default due time</label>
      <input id="tTime" type="time" value="19:00"/>
      <button id="addTopic" class="primary">Add</button>
    </div>

    <div class="sep"></div>

    <div class="row" style="justify-content:space-between">
      <div><b>Due Today</b> <span class="badge due" id="dueCount">0</span></div>
      <div class="small muted" id="todayStr"></div>
    </div>
    <div id="queue"></div>

    <div class="sep"></div>

    <details>
      <summary>All Topics</summary>
      <div id="topics"></div>
    </details>
  </section>

  <!-- RIGHT: calendar & summary -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevM">â—€</button>
        <div id="monthTitle" style="font-weight:700"></div>
        <button id="nextM">â–¶</button>
      </div>
      <div class="row">
        <span class="pill"><span>Due</span><b id="mDue">0</b></span>
        <span class="pill"><span>Late</span><b id="mLate">0</b></span>
      </div>
    </div>
    <div class="grid" id="cal"></div>

    <div class="sep"></div>

    <div class="summary">
      <div class="card">
        <div class="big" id="statDue">0</div>
        <div class="muted">Due this month</div>
      </div>
      <div class="card">
        <div class="big" id="statDone">0</div>
        <div class="muted">Reviews done this month</div>
      </div>
      <div class="card">
        <div class="big" id="streak">0</div>
        <div class="muted">Daily streak (any reviews)</div>
      </div>
    </div>
  </section>
</div>

<footer class="muted">
  <div>Tip: Export ICS and add it to Apple/Google Calendar to get notifications on iPad or Gmail.</div>
  <div class="right small">Local-only; data saved to your browser.</div>
</footer>

<script>
/*** Data model ***/
// topic: { id, title, tags[], ef, reps, interval, dueISO, lastISO, defaultTime, history[] }
const SK = "sr.topics.v1";
let topics = load();
function load(){ try{ return JSON.parse(localStorage.getItem(SK))||[] }catch(e){ return [] } }
function save(){ localStorage.setItem(SK, JSON.stringify(topics)) }

const $ = q => document.querySelector(q);
const today = () => new Date();
const pad2 = n => String(n).padStart(2,"0");
const ymd = d => d.toISOString().slice(0,10);
const ymdhm = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
const parseLocal = s => new Date(s); // from <input type="time"> or iso yyyy-mm-ddThh:mm

function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x }
function isSameDay(a,b){ return startOfDay(a).getTime()===startOfDay(b).getTime() }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x }

function nextIntervalSM2(t, q){
  // q: 0-5 (Again 0..Easy 5). Returns updated ef, reps, interval (days)
  let ef = t.ef ?? 2.5;
  let reps = t.reps ?? 0;
  let interval = t.interval ?? 0;

  if (q < 3){ reps = 0; interval = 1; }        // fail â†’ back to 1 day
  else{
    if (reps === 0) interval = 1;
    else if (reps === 1) interval = 3;
    else interval = Math.round(interval * ef);
    reps += 1;
    ef = Math.max(1.3, ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02)));
  }
  return { ef, reps, interval };
}

function addTopic(title, tags, startWhen, defaultTime){
  const now = today();
  const firstDate = startWhen==="today" ? now : addDays(now,1);
  const [hh,mm] = defaultTime.split(":").map(Number);
  const due = new Date(firstDate); due.setHours(hh,mm,0,0);

  topics.push({
    id: crypto.randomUUID(),
    title, tags, ef:2.5, reps:0, interval:1,
    dueISO: due.toISOString(),
    lastISO: null,
    defaultTime,
    history:[]
  });
  save();
  renderAll();
}

/*** UI: Add & list ***/
$("#addTopic").addEventListener("click", ()=>{
  const title=$("#tTitle").value.trim(); if(!title) return;
  const tags=$("#tTags").value.split(",").map(s=>s.trim()).filter(Boolean);
  addTopic(title, tags, $("#tStart").value, $("#tTime").value);
  $("#tTitle").value=""; $("#tTags").value="";
});

function renderTopics(){
  const box=$("#topics"); box.innerHTML="";
  for (const t of topics){
    const next = new Date(t.dueISO);
    const row = document.createElement("div");
    row.className="topicrow";
    const status = next < today() ? `<span class="badge late">late</span>` : `<span class="badge ok">scheduled</span>`;
    row.innerHTML = `
      <div><b>${t.title}</b> <span class="small muted">${(t.tags||[]).join(", ")}</span></div>
      <div class="small">EF ${t.ef.toFixed(2)}</div>
      <div class="small">${t.reps} reps</div>
      <div class="small">${ymdhm(next)}</div>`;
    box.appendChild(row);
  }
}

/*** Review queue ***/
function dueToday(){
  const out=[];
  const now = today();
  for (const t of topics){
    const due = new Date(t.dueISO);
    if (startOfDay(due) <= startOfDay(now)) out.push(t);
  }
  // Sort: oldest due first
  return out.sort((a,b)=> new Date(a.dueISO)-new Date(b.dueISO));
}
function queueItem(t){
  const wrap=document.createElement("div"); wrap.className="queueitem"; 
  const next = new Date(t.dueISO);
  wrap.innerHTML=`<div>
    <div><b>${t.title}</b></div>
    <div class="small muted">due ${ymdhm(next)}</div>
  </div>
  <div class="qbtns">
    <button data-q="0">Again</button>
    <button data-q="3">Hard</button>
    <button data-q="4">Good</button>
    <button data-q="5">Easy</button>
  </div>`;
  wrap.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      grade(t, +btn.dataset.q);
    });
  });
  return wrap;
}
function grade(t, q){
  const upd = nextIntervalSM2(t, q);
  t.ef = upd.ef; t.reps = upd.reps; t.interval = upd.interval;
  t.lastISO = (new Date()).toISOString();

  // next due at default time
  const d = addDays(today(), t.interval);
  const [hh,mm] = (t.defaultTime || "19:00").split(":").map(Number);
  d.setHours(hh,mm,0,0);
  t.dueISO = d.toISOString();

  t.history.push({ts: t.lastISO, q});
  save();
  renderAll();
}

function renderQueue(){
  const q = $("#queue"); q.innerHTML="";
  const items = dueToday();
  $("#dueCount").textContent = items.length;
  $("#todayStr").textContent = (new Date()).toLocaleDateString(undefined,{weekday:"short",year:"numeric",month:"short",day:"numeric"});
  if(!items.length){ q.innerHTML=`<div class="muted">Nothing due today ðŸŽ‰</div>`; return; }
  items.forEach(t=> q.appendChild(queueItem(t)));
}

/*** Calendar ***/
function monthMeta(ymStr){
  const [Y,M] = ymStr.split("-").map(Number);
  const first=new Date(Y,M-1,1);
  const startW=first.getDay();
  const days=new Date(Y,M,0).getDate();
  return {Y,M,startW,days};
}
function ym(d){ return d.toISOString().slice(0,7) }
const monthPick = { value: ym(today()) };

function renderCalendar(){
  const mval = monthPick.value;
  const {Y,M,startW,days} = monthMeta(mval);
  $("#monthTitle").textContent = new Date(Y,M-1).toLocaleString(undefined,{month:"long",year:"numeric"});
  const cal=$("#cal"); cal.innerHTML="";
  for(let i=0;i<startW;i++){ const g=document.createElement("div"); g.className="day"; cal.appendChild(g) }

  let due=0, late=0, done=0, streak=0, curStreak=0, lastHadReview=null;
  for(let d=1; d<=days; d++){
    const key = `${mval}-${String(d).padStart(2,"0")}`;
    const cell=document.createElement("div"); cell.className="day";
    cell.innerHTML=`<div class="dnum">${d}</div><div class="count" id="c-${key}">0</div>`;
    cal.appendChild(cell);

    const start = new Date(key+"T00:00:00");
    const end   = addDays(start,1);

    // counts
    const dueN = topics.filter(t=> new Date(t.dueISO) >= start && new Date(t.dueISO) < end).length;
    const lateN= topics.filter(t=> new Date(t.dueISO) < start).length;
    document.getElementById(`c-${key}`).textContent = dueN>0 ? dueN : "Â·";
    if (dueN>0) due += dueN;
    if (lateN>0) late = lateN;

    // check if any review happened this day (from history)
    const had = topics.some(t => (t.history||[]).some(h=> {
      const ts=new Date(h.ts); return ts>=start && ts<end;
    }));
    if (had){ curStreak = (lastHadReview && isSameDay(addDays(lastHadReview,1), start)) ? curStreak+1 : 1; lastHadReview = start; }
    else if (isSameDay(start,today())){ /* keep running */ }
    else { /* gaps break streak but we continue computing */ }
    if (curStreak>streak) streak=curStreak;
  }
  $("#mDue").textContent = due;
  $("#mLate").textContent = late;
  $("#statDue").textContent = due;
  $("#streak").textContent = streak;

  // reviews done this month
  const mStart = new Date(`${mval}-01T00:00:00`), mEnd= addDays(new Date(`${mval}-${pad2(days)}T00:00:00`),1);
  for (const t of topics) done += (t.history||[]).filter(h=>{ const ts=new Date(h.ts); return ts>=mStart && ts<mEnd; }).length;
  $("#statDone").textContent = done;
}

$("#prevM").addEventListener("click", ()=>{
  const [Y,M]=monthPick.value.split("-").map(Number);
  const prev=new Date(Y, M-2, 1); monthPick.value = ym(prev); renderCalendar();
});
$("#nextM").addEventListener("click", ()=>{
  const [Y,M]=monthPick.value.split("-").map(Number);
  const next=new Date(Y, M, 1); monthPick.value = ym(next); renderCalendar();
});

/*** Export / Import ***/
$("#exportJson").addEventListener("click", ()=>{
  const blob=new Blob([JSON.stringify({topics},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="spaced-repetition-backup.json"; a.click(); URL.revokeObjectURL(url);
});
document.querySelector("label input#importJson").addEventListener("change",(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{
    const data=JSON.parse(r.result); topics = data.topics || []; save(); renderAll(); alert("Imported");
  }catch(_){ alert("Invalid JSON") } }; r.readAsText(f);
});

/*** ICS export (next due occurrences only, with 10-minute alert) ***/
$("#exportIcs").addEventListener("click", ()=>{
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const lines = [
    "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//SpaceRepetition//EN"
  ];
  const now = new Date();
  for (const t of topics){
    const due = new Date(t.dueISO);
    if (due < addDays(now,-1)) continue; // skip very old
    const uid = `sr-${t.id}@local`;
    const dt = due.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z"; // UTC
    lines.push(
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,"").split(".")[0]}Z`,
      `SUMMARY:Recall â€“ ${t.title}`,
      `DESCRIPTION:SR review (${(t.tags||[]).join(", ")})`,
      `DTSTART:${dt}`,
      `DTEND:${dt}`, // all-day moment, reminder will pop
      "BEGIN:VALARM","ACTION:DISPLAY","DESCRIPTION:Review","TRIGGER:-PT10M","END:VALARM",
      "END:VEVENT"
    );
  }
  lines.push("END:VCALENDAR");
  const blob=new Blob([lines.join("\r\n")],{type:"text/calendar"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="sr-next.ics"; a.click(); URL.revokeObjectURL(url);
});

/*** Render all ***/
function renderAll(){ renderQueue(); renderTopics(); renderCalendar(); }
renderAll();
</script>
</body>
</html>
